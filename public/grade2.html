
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>2학년 게시판</title>
</head>
<body>
  <h1>📚 2학년 게시판</h1>

  <h2>글 작성</h2>
  <input id="title" placeholder="제목"><br />
  <textarea id="content" placeholder="내용"></textarea><br />
  <button onclick="writePost()">작성하기</button>
  <button onclick="logout()">로그아웃</button>

  <h2>📄 전체 글 목록</h2>
  <div id="posts"></div>

  <script>
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user) {{
      alert("로그인이 필요합니다!");
      window.location.href = "/login.html";
    }}

    const FIXED_GRADE = 2;

    function isUserBanned() {{
      return user.bannedUntil && new Date(user.bannedUntil) > new Date();
    }}

    function logout() {{
      localStorage.removeItem("user");
      alert("로그아웃되었습니다.");
      location.href = "/login.html";
    }}

    async function writePost() {{
      if (isUserBanned()) {{
        alert("밴된 유저는 글을 작성할 수 없습니다.");
        return;
      }}

      const title = document.getElementById("title").value;
      const content = document.getElementById("content").value;

      const res = await fetch("/post", {{
        method: "POST",
        headers: {{ "Content-Type": "application/json" }},
        body: JSON.stringify({{
          title,
          content,
          author: user.name,
          grade: FIXED_GRADE
        }})
      }});

      const msg = await res.text();
      alert(msg);
      loadPosts();
    }}

    async function loadPosts() {{
      const res = await fetch("/posts");
      const posts = await res.json();

      const container = document.getElementById("posts");
      const filtered = posts.filter(p => p.grade === FIXED_GRADE);

      const pinned = filtered.filter(p => p.pinned);
      const others = filtered.filter(p => !p.pinned);
      const sorted = [...pinned, ...others];

      container.innerHTML = sorted.map(p => {{
        const isMine = user.name === p.author && p.grade === FIXED_GRADE;
        return `
<div style="border:1px solid #aaa; margin:10px; padding:10px;">
  <strong>${{p.pinned ? "📌 " : ""}}${{p.title}}</strong> (${{p.grade}}학년 ${{p.author}})<br/>
  <pre>${{p.content}}</pre>
  <div>
    👍 ${{p.likes}} <button onclick="votePost('${{p._id}}', 'like')">좋아요</button>
    👎 ${{p.dislikes}} <button onclick="votePost('${{p._id}}', 'dislike')">싫어요</button>
  </div>
  ${(isMine || user.isAdmin) ? `
    <button onclick="editPost('${{p._id}}', '${{p.title}}', \`${{p.content}}\`)">✏️ 수정</button>
    <button onclick="deletePost('${{p._id}}')">🗑 삭제</button>
    ${{user.isAdmin ? `<button onclick="togglePin('${{p._id}}', ${{p.pinned}})">${{p.pinned ? "📌 고정 해제" : "📌 고정"}}</button>` : ""}}
  ` : ""}
  <input id="comment-${{p._id}}" placeholder="댓글 작성" />
  <button onclick="writeComment('${{p._id}}')">등록</button>
</div>
        `;
      }}).join("");
    }}

    async function votePost(postId, type) {{
      const res = await fetch(`/post/${{postId}}/${{type}}`, {{ method: "POST" }});
      const msg = await res.text();
      alert(msg);
      loadPosts();
    }}

    async function deletePost(postId) {{
      const res = await fetch(`/post/${{postId}}`, {{ method: "DELETE" }});
      const msg = await res.text();
      alert(msg);
      loadPosts();
    }}

    function editPost(id, title, content) {{
      const newTitle = prompt("수정할 제목", title);
      const newContent = prompt("수정할 내용", content);

      fetch(`/post/${{id}}`, {{
        method: "PUT",
        headers: {{ "Content-Type": "application/json" }},
        body: JSON.stringify({{ title: newTitle, content: newContent }})
      }})
      .then(res => res.text())
      .then(alert)
      .then(loadPosts);
    }}

    async function writeComment(postId) {{
      const commentInput = document.getElementById(`comment-${{postId}}`);
      const content = commentInput.value;
      const res = await fetch(`/post/${{postId}}/comment`, {{
        method: "POST",
        headers: {{ "Content-Type": "application/json" }},
        body: JSON.stringify({{ author: user.name, content }})
      }});
      const msg = await res.text();
      alert(msg);
      loadPosts();
    }}

    async function togglePin(postId, pinned) {{
      const res = await fetch(`/post/${{postId}}/pin`, {{
        method: "PUT",
        headers: {{ "Content-Type": "application/json" }},
        body: JSON.stringify({{ pinned: !pinned }})
      }});
      const msg = await res.text();
      alert(msg);
      loadPosts();
    }}

    loadPosts();
  </script>
</body>
</html>
