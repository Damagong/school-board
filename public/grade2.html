
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>2í•™ë…„ ê²Œì‹œíŒ</title>
</head>
<body>
  <h1>ğŸ“š 2í•™ë…„ ê²Œì‹œíŒ</h1>

  <h2>ê¸€ ì‘ì„±</h2>
  <input id="title" placeholder="ì œëª©"><br />
  <textarea id="content" placeholder="ë‚´ìš©"></textarea><br />
  <button onclick="writePost()">ì‘ì„±í•˜ê¸°</button>
  <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>

  <h2>ğŸ“„ ì „ì²´ ê¸€ ëª©ë¡</h2>
  <div id="posts"></div>

  <script>
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user) {{
      alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!");
      window.location.href = "/login.html";
    }}

    const FIXED_GRADE = 2;

    function isUserBanned() {{
      return user.bannedUntil && new Date(user.bannedUntil) > new Date();
    }}

    function logout() {{
      localStorage.removeItem("user");
      alert("ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.");
      location.href = "/login.html";
    }}

    async function writePost() {{
      if (isUserBanned()) {{
        alert("ë°´ëœ ìœ ì €ëŠ” ê¸€ì„ ì‘ì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }}

      const title = document.getElementById("title").value;
      const content = document.getElementById("content").value;

      const res = await fetch("/post", {{
        method: "POST",
        headers: {{ "Content-Type": "application/json" }},
        body: JSON.stringify({{
          title,
          content,
          author: user.name,
          grade: FIXED_GRADE
        }})
      }});

      const msg = await res.text();
      alert(msg);
      loadPosts();
    }}

    async function loadPosts() {{
      const res = await fetch("/posts");
      const posts = await res.json();

      const container = document.getElementById("posts");
      const filtered = posts.filter(p => p.grade === FIXED_GRADE);

      const pinned = filtered.filter(p => p.pinned);
      const others = filtered.filter(p => !p.pinned);
      const sorted = [...pinned, ...others];

      container.innerHTML = sorted.map(p => {{
        const isMine = user.name === p.author && p.grade === FIXED_GRADE;
        return `
<div style="border:1px solid #aaa; margin:10px; padding:10px;">
  <strong>${{p.pinned ? "ğŸ“Œ " : ""}}${{p.title}}</strong> (${{p.grade}}í•™ë…„ ${{p.author}})<br/>
  <pre>${{p.content}}</pre>
  <div>
    ğŸ‘ ${{p.likes}} <button onclick="votePost('${{p._id}}', 'like')">ì¢‹ì•„ìš”</button>
    ğŸ‘ ${{p.dislikes}} <button onclick="votePost('${{p._id}}', 'dislike')">ì‹«ì–´ìš”</button>
  </div>
  ${(isMine || user.isAdmin) ? `
    <button onclick="editPost('${{p._id}}', '${{p.title}}', \`${{p.content}}\`)">âœï¸ ìˆ˜ì •</button>
    <button onclick="deletePost('${{p._id}}')">ğŸ—‘ ì‚­ì œ</button>
    ${{user.isAdmin ? `<button onclick="togglePin('${{p._id}}', ${{p.pinned}})">${{p.pinned ? "ğŸ“Œ ê³ ì • í•´ì œ" : "ğŸ“Œ ê³ ì •"}}</button>` : ""}}
  ` : ""}
  <input id="comment-${{p._id}}" placeholder="ëŒ“ê¸€ ì‘ì„±" />
  <button onclick="writeComment('${{p._id}}')">ë“±ë¡</button>
</div>
        `;
      }}).join("");
    }}

    async function votePost(postId, type) {{
      const res = await fetch(`/post/${{postId}}/${{type}}`, {{ method: "POST" }});
      const msg = await res.text();
      alert(msg);
      loadPosts();
    }}

    async function deletePost(postId) {{
      const res = await fetch(`/post/${{postId}}`, {{ method: "DELETE" }});
      const msg = await res.text();
      alert(msg);
      loadPosts();
    }}

    function editPost(id, title, content) {{
      const newTitle = prompt("ìˆ˜ì •í•  ì œëª©", title);
      const newContent = prompt("ìˆ˜ì •í•  ë‚´ìš©", content);

      fetch(`/post/${{id}}`, {{
        method: "PUT",
        headers: {{ "Content-Type": "application/json" }},
        body: JSON.stringify({{ title: newTitle, content: newContent }})
      }})
      .then(res => res.text())
      .then(alert)
      .then(loadPosts);
    }}

    async function writeComment(postId) {{
      const commentInput = document.getElementById(`comment-${{postId}}`);
      const content = commentInput.value;
      const res = await fetch(`/post/${{postId}}/comment`, {{
        method: "POST",
        headers: {{ "Content-Type": "application/json" }},
        body: JSON.stringify({{ author: user.name, content }})
      }});
      const msg = await res.text();
      alert(msg);
      loadPosts();
    }}

    async function togglePin(postId, pinned) {{
      const res = await fetch(`/post/${{postId}}/pin`, {{
        method: "PUT",
        headers: {{ "Content-Type": "application/json" }},
        body: JSON.stringify({{ pinned: !pinned }})
      }});
      const msg = await res.text();
      alert(msg);
      loadPosts();
    }}

    loadPosts();
  </script>
</body>
</html>
